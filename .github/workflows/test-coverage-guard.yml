name: Test Coverage Guard

on:
  pull_request:
    branches:
      - '**'

jobs:
  require-tests-for-src-changes:
    name: Require Tests For Source Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed source files
        id: src
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php

      - name: Detect changed test files
        id: tests
        uses: tj-actions/changed-files@v46
        with:
          files: |
            tests/**/*.php

      - name: Enforce test updates for source changes
        if: steps.src.outputs.any_changed == 'true' && steps.tests.outputs.any_changed != 'true'
        run: |
          echo "Source PHP files changed in src/, but no test files changed in tests/."
          echo "Please add or update tests to cover the code changes."
          exit 1

      - name: Coverage guard passed
        if: steps.src.outputs.any_changed != 'true' || steps.tests.outputs.any_changed == 'true'
        run: echo "Coverage guard passed."
